<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accounting CRM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 28px; max-width: 980px; }
    h1 { margin: 0 0 10px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 14px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; }
    input, select, textarea { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 10px; }
    textarea { min-height: 70px; resize: vertical; }
    button { padding: 10px 14px; font-size: 15px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    .actions { display:flex; gap:10px; align-items:center; margin-top: 12px; flex-wrap: wrap; }
    .small { color:#666; font-size: 13px; }
    .list { margin-top: 10px; }
    .item { padding: 10px; border: 1px solid #eee; border-radius: 10px; margin-top: 8px; }
    .item b { display:inline-block; min-width: 90px; }
    .summaryGrid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
    .summaryBox { border:1px solid #eee; border-radius: 12px; padding: 12px; }
    .summaryBox .label { color:#666; font-size: 13px; }
    .summaryBox .value { font-size: 20px; margin-top: 6px; }
  </style>
</head>
<body>
  <h1>Accounting CRM</h1>
  <div class="small">Single-user mode ✅ (login later)</div>

  <!-- ADD TRANSACTION -->
  <div class="card">
    <h3 style="margin:0 0 10px;">Add Transaction</h3>

    <div class="row">
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>Amount (use negative for expense)</label>
        <input id="amount" type="number" step="0.01" placeholder="e.g. 1500 or -250.75" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Bank Account (last 4 digits)</label>
        <select id="account">
          <option value="8930">8930</option>
          <option value="9081">9081</option>
          <option value="OTHER">OTHER</option>
        </select>
      </div>
      <div>
        <label>Category</label>
        <select id="category">
          <option value="Sales">Sales</option>
          <option value="Sales Reimbursement">Sales Reimbursement</option>
          <option value="COGS">COGS</option>
          <option value="Repairs & Maintenance">Repairs & Maintenance</option>
          <option value="Fuel">Fuel</option>
          <option value="Payroll">Payroll</option>
          <option value="Contract Labor">Contract Labor</option>
          <option value="Loan from Others">Loan from Others</option>
          <option value="Internal Transfer">Internal Transfer</option>
          <option value="Other Expense">Other Expense</option>
          <option value="Other Income">Other Income</option>
        </select>
      </div>
    </div>

    <label>Description / Memo</label>
    <textarea id="description" placeholder="e.g. Zelle deposit / Wentworth Tire invoice / Transfer from CHK ..."></textarea>

    <div class="actions">
      <button id="saveBtn">Save</button>
      <button id="clearBtn" type="button">Clear</button>
      <span id="status"></span>
    </div>
  </div>

  <!-- MONTHLY SUMMARY -->
  <div class="card">
    <div class="actions" style="margin-top:0;">
      <h3 style="margin:0; flex:1;">Monthly Summary (Accounting Logic)</h3>

      <div style="min-width:220px;">
        <label style="margin:0 0 6px;">Month</label>
        <input id="monthPick" type="month" />
      </div>

      <div style="min-width:220px;">
        <label style="margin:0 0 6px;">Account filter</label>
        <select id="filterAccount">
          <option value="ALL">All</option>
          <option value="8930">8930</option>
          <option value="9081">9081</option>
          <option value="OTHER">OTHER</option>
        </select>
      </div>
    </div>

    <div class="summaryGrid">
      <div class="summaryBox">
        <div class="label">Income (Sales/Other Income/Reimb.)</div>
        <div class="value" id="sumIncome">$0.00</div>
      </div>
      <div class="summaryBox">
        <div class="label">Expenses (COGS/Payroll/etc.)</div>
        <div class="value" id="sumExpense">$0.00</div>
      </div>
      <div class="summaryBox">
        <div class="label">Net (Income − Expenses)</div>
        <div class="value" id="sumNet">$0.00</div>
      </div>
    </div>

    <div class="small" style="margin-top:8px;">
      Loans and Internal Transfers are excluded from P&L totals ✅
    </div>
  </div>

  <!-- RECENT TRANSACTIONS -->
  <div class="card">
    <div class="actions" style="margin-top:0;">
      <h3 style="margin:0; flex:1;">Recent Transactions (last 10)</h3>
      <div class="small">Uses the same account filter above</div>
    </div>
    <div id="list" class="list"></div>
  </div>

  <!-- RUNNING BALANCE -->
  <div class="card">
    <h3 style="margin:0 0 10px;">Running Bank Balance</h3>

    <div class="row">
      <div>
        <label>Account</label>
        <select id="balanceAccount">
          <option value="8930">8930</option>
          <option value="9081">9081</option>
        </select>
      </div>
      <div>
        <label>Starting Balance</label>
        <input id="startingBalance" type="number" step="0.01" placeholder="Enter beginning balance" />
      </div>
    </div>

    <button id="calcBalanceBtn" style="margin-top:12px;">Calculate Running Balance</button>

    <div id="balanceTable" style="margin-top:15px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp,
      query, orderBy, limit, onSnapshot, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZti11UlAEp5_7fcB9r8l7i1HpIQxhLwg",
      authDomain: "accounting-crm-web.firebaseapp.com",
      projectId: "accounting-crm-web",
      storageBucket: "accounting-crm-web.firebasestorage.app",
      messagingSenderId: "312052820860",
      appId: "1:312052820860:web:38dabd80841df9de99d2f9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const el = (id) => document.getElementById(id);
    const statusEl = el("status");
    const listEl = el("list");
    const filterEl = el("filterAccount");
    const monthEl = el("monthPick");

    // ---------- CATEGORY RULES (Accounting Logic) ----------
    const INCOME_CATEGORIES = new Set(["Sales", "Other Income", "Sales Reimbursement"]);
    const EXPENSE_CATEGORIES = new Set(["COGS", "Repairs & Maintenance", "Fuel", "Payroll", "Contract Labor", "Other Expense"]);
    const EXCLUDED_CATEGORIES = new Set(["Loan from Others", "Internal Transfer"]);
    // ------------------------------------------------------

    // defaults
    el("date").value = new Date().toISOString().slice(0,10);
    monthEl.value = new Date().toISOString().slice(0,7); // YYYY-MM

    el("clearBtn").onclick = () => {
      el("amount").value = "";
      el("description").value = "";
      el("account").value = "8930";
      el("category").value = "Sales";
      el("date").value = new Date().toISOString().slice(0,10);
      statusEl.textContent = "";
    };

    el("saveBtn").onclick = async () => {
      const date = el("date").value.trim();
      const amountStr = el("amount").value.trim();
      const amount = Number(amountStr);
      const account = el("account").value;
      const category = el("category").value;
      const description = el("description").value.trim();

      if (!date) return statusEl.textContent = "❌ Date required";
      if (!amountStr || Number.isNaN(amount)) return statusEl.textContent = "❌ Amount required";
      if (!description) return statusEl.textContent = "❌ Description required";

      try {
        const docRef = await addDoc(collection(db, "transactions"), {
          date, amount, account, category, description,
          createdAt: serverTimestamp()
        });
        statusEl.textContent = "✅ Saved: " + docRef.id;
        el("amount").value = "";
        el("description").value = "";
        await refreshMonthlySummary();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "❌ " + e.message;
      }
    };

    // ----- Recent list with filter -----
    let unsubscribe = null;

    function renderList(snap){
      listEl.innerHTML = "";
      snap.forEach((doc) => {
        const t = doc.data();
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div><b>Date:</b> ${t.date || ""}</div>
          <div><b>Amount:</b> ${t.amount ?? ""}</div>
          <div><b>Acct:</b> ${t.account || ""} &nbsp; <b>Cat:</b> ${t.category || ""}</div>
          <div><b>Memo:</b> ${escapeHtml(t.description || "")}</div>
        `;
        listEl.appendChild(div);
      });
    }

    function subscribeRecent(){
      if (unsubscribe) unsubscribe();
      const selected = filterEl.value;

      let q;
      if (selected === "ALL") {
        q = query(collection(db, "transactions"), orderBy("createdAt", "desc"), limit(10));
      } else {
        q = query(
          collection(db, "transactions"),
          where("account", "==", selected),
          orderBy("createdAt", "desc"),
          limit(10)
        );
      }

      unsubscribe = onSnapshot(q, renderList);
    }

    // ----- Monthly summary (category-based) -----
    function monthRange(monthValue){
      const [y, m] = monthValue.split("-").map(Number);
      const start = `${y}-${String(m).padStart(2,"0")}-01`;
      const endDate = new Date(y, m, 0);
      const end = `${y}-${String(m).padStart(2,"0")}-${String(endDate.getDate()).padStart(2,"0")}`;
      return { start, end };
    }

    function money(n){
      const num = Number(n || 0);
      return num.toLocaleString(undefined, { style:"currency", currency:"USD" });
    }

    async function refreshMonthlySummary(){
      const monthValue = monthEl.value;
      const { start, end } = monthRange(monthValue);
      const selected = filterEl.value;

      let q;
      if (selected === "ALL") {
        q = query(
          collection(db, "transactions"),
          where("date", ">=", start),
          where("date", "<=", end)
        );
      } else {
        q = query(
          collection(db, "transactions"),
          where("account", "==", selected),
          where("date", ">=", start),
          where("date", "<=", end)
        );
      }

      const snap = await getDocs(q);

      let income = 0;
      let expense = 0;

      snap.forEach((doc) => {
        const t = doc.data();
        const amt = Number(t.amount || 0);
        const cat = String(t.category || "");

        if (EXCLUDED_CATEGORIES.has(cat)) return;

        if (INCOME_CATEGORIES.has(cat)) {
          income += Math.abs(amt);
          return;
        }

        if (EXPENSE_CATEGORIES.has(cat)) {
          expense += Math.abs(amt);
          return;
        }
      });

      el("sumIncome").textContent = money(income);
      el("sumExpense").textContent = money(expense);
      el("sumNet").textContent = money(income - expense);
    }

    filterEl.addEventListener("change", async () => {
      subscribeRecent();
      await refreshMonthlySummary();
    });

    monthEl.addEventListener("change", refreshMonthlySummary);

    // -------- RUNNING BALANCE (safe query + on-page errors) --------
    const balanceAccountEl = el("balanceAccount");
    const startingBalanceEl = el("startingBalance");
    const balanceTableEl = el("balanceTable");
    const calcBtn = el("calcBalanceBtn");

    calcBtn.onclick = async () => {
      balanceTableEl.innerHTML = "Loading...";

      try {
        const account = balanceAccountEl.value;
        const startingBalance = Number(startingBalanceEl.value || 0);

        // Uses createdAt to avoid composite index issues (same as recent list)
        const q = query(
          collection(db, "transactions"),
          where("account", "==", account),
          orderBy("createdAt", "asc")
        );

        const snap = await getDocs(q);

        if (snap.size === 0) {
          balanceTableEl.innerHTML = "No transactions found for account " + account;
          return;
        }

        let running = startingBalance;

        let html = `
          <table border="1" cellpadding="6" style="border-collapse:collapse; width:100%;">
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Category</th>
              <th>Memo</th>
              <th>Running Balance</th>
            </tr>
        `;

        snap.forEach(doc => {
          const t = doc.data();
          const amt = Number(t.amount || 0);
          running += amt;

          html += `
            <tr>
              <td>${t.date || ""}</td>
              <td>${amt.toFixed(2)}</td>
              <td>${t.category || ""}</td>
              <td>${escapeHtml(t.description || "")}</td>
              <td>${running.toFixed(2)}</td>
            </tr>
          `;
        });

        html += "</table>";
        balanceTableEl.innerHTML = html;

      } catch (e) {
        console.error(e);
        balanceTableEl.innerHTML = "Error ❌ " + e.message;
      }
    };
    // -------------------------------------------------------------

    // start
    subscribeRecent();
    refreshMonthlySummary();

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
