<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accounting CRM</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 22px; max-width: 1200px; }
    h1 { margin: 0 0 10px; }
    .small { color:#666; font-size: 13px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .row4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-top: 14px; }
    label { display:block; font-size: 13px; margin: 10px 0 6px; }
    input, select, textarea { width: 100%; padding: 10px; font-size: 15px; border: 1px solid #ccc; border-radius: 10px; }
    textarea { min-height: 70px; resize: vertical; }
    button { padding: 10px 14px; font-size: 15px; border-radius: 10px; border: 1px solid #ccc; cursor: pointer; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .actions { display:flex; gap:10px; align-items:center; margin-top: 12px; flex-wrap: wrap; }
    .list { margin-top: 10px; }
    .item { padding: 10px; border: 1px solid #eee; border-radius: 10px; margin-top: 8px; }
    .item b { display:inline-block; min-width: 90px; }
    .summaryGrid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
    .summaryBox { border:1px solid #eee; border-radius: 12px; padding: 12px; }
    .summaryBox .label { color:#666; font-size: 13px; }
    .summaryBox .value { font-size: 20px; margin-top: 6px; }

    /* Tabs */
    .tabs { display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    .tabBtn { background:#fff; }
    .tabBtn.active { border-color:#111; font-weight:700; }
    .tabPanel { display:none; }
    .tabPanel.active { display:block; }

    /* Tables */
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border:1px solid #eee; padding: 10px; text-align:left; font-size: 14px; vertical-align: top; }
    th { background:#fafafa; }
    .right { text-align:right; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; border:1px solid #ddd; font-size: 12px; color:#444; }
    .danger { color:#b00020; font-weight:700; }
    .ok { color:#0b6b2f; font-weight:700; }
    .muted { color:#777; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .nowrap { white-space: nowrap; }

    .toggleRow { display:flex; align-items:center; gap:10px; }
    .toggleRow input[type="checkbox"] { width:auto; transform: scale(1.2); }
    .hint { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h1>Accounting CRM</h1>
  <div class="small">Single-user mode ✅ (login later) • Firebase/Firestore ✅ • Import/Export ✅ • Vendor AP ✅ • Monthly Lock ✅</div>

  <!-- TOP NAV -->
  <div class="tabs" id="tabs">
    <button class="tabBtn active" data-tab="dashboard">Dashboard</button>
    <button class="tabBtn" data-tab="transactions">Transactions</button>
    <button class="tabBtn" data-tab="vendors">Vendors</button>
    <button class="tabBtn" data-tab="ap">AP Summary</button>
    <button class="tabBtn" data-tab="apledger">AP Ledger</button>
    <button class="tabBtn" data-tab="audit">Audit Monthly</button>
    <button class="tabBtn" data-tab="importexport">Import/Export</button>
    <button class="tabBtn" data-tab="archive">Archive</button>
  </div>

  <!-- AP LEDGER -->
<div id="tab-apledger" class="tabPanel">
  <div class="card">
    <h2 style="margin:0 0 10px;">Accounts Payable — Daily Vendor Ledger</h2>
    <div class="muted" style="margin-bottom:10px;">
      Click a vendor to open the daily ledger (debit/bill increases balance, credit/payment decreases).
    </div>

    <div class="row" style="gap:10px;">
      <div style="flex:1;">
        <label>Search Vendor</label>
        <input id="apVendorSearch" placeholder="Type vendor name..." />
      </div>
      <div style="width:220px;">
        <label>Group</label>
        <select id="apVendorGroupFilter">
          <option value="ALL">All</option>
          <option value="General">General</option>
          <option value="Tires">Tires</option>
          <option value="Parts">Parts</option>
          <option value="Fuel">Fuel</option>
        </select>
      </div>
      <div style="width:160px; display:flex; align-items:flex-end;">
        <button id="apLedgerRefreshBtn">Refresh</button>
      </div>
    </div>

    <div style="margin-top:12px; overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Group</th>
            <th class="right">Current Balance</th>
            <th class="right">Bills</th>
            <th class="right">Payments</th>
            <th class="right">Credits</th>
          </tr>
        </thead>
        <tbody id="apLedgerVendorsBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Vendor Detail -->
  <div class="card" style="margin-top:14px;">
    <div class="row" style="align-items:center; gap:12px;">
      <h3 style="margin:0;">Vendor Ledger</h3>
      <span id="apSelectedVendorPill" class="pill">No vendor selected</span>
      <span style="flex:1;"></span>
      <span id="apVendorBalancePill" class="pill">Balance: $0.00</span>
    </div>

    <div class="row" style="gap:10px; margin-top:12px;">
      <div style="width:160px;">
        <label>Date</label>
        <input id="apEntryDate" type="date" />
      </div>

      <div style="width:170px;">
        <label>Type</label>
        <select id="apEntryType">
          <option value="BILL">Debit (Bill)</option>
          <option value="PAYMENT">Credit (Payment)</option>
          <option value="CREDIT">Credit Memo</option>
        </select>
      </div>

      <div style="width:180px;">
        <label>Amount</label>
        <input id="apEntryAmount" type="number" step="0.01" placeholder="0.00" />
      </div>

      <div style="width:140px;">
        <label>Account</label>
        <select id="apEntryAccount">
          <option value="8930">8930</option>
          <option value="9081">9081</option>
          <option value="OTHER">OTHER</option>
        </select>
      </div>

      <div style="width:200px;">
        <label>Category</label>
        <select id="apEntryCategory">
          <option value="COGS">COGS</option>
          <option value="Repairs & Maintenance">Repairs & Maintenance</option>
          <option value="Other Expense">Other Expense</option>
        </select>
      </div>

      <div style="flex:1;">
        <label>Invoice/Ref #</label>
        <input id="apEntryRefNo" placeholder="INV / CHECK / Ref..." />
      </div>

      <div style="width:170px; display:flex; align-items:flex-end; gap:8px;">
        <button id="apAddEntryBtn">Add</button>
        <button id="apClearEntryBtn" class="secondary">Clear</button>
      </div>
    </div>

    <div style="margin-top:12px; overflow:auto;">
      <table class="table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th class="right">Amount</th>
            <th class="right">Running Balance</th>
            <th>Ref #</th>
            <th>Account</th>
            <th>Category</th>
            <th>Memo</th>
          </tr>
        </thead>
        <tbody id="apVendorLedgerBody"></tbody>
      </table>
    </div>

    <div id="apLedgerStatus" class="muted" style="margin-top:10px;"></div>
  </div>
</div>

  <!-- DASHBOARD -->
  <div class="tabPanel active" id="tab-dashboard">
    <!-- ADD TRANSACTION -->
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Add Transaction</h3>
        <span class="pill" id="editModePill" title="Editing OFF blocks Save/Import to prevent accidental changes.">Editing: …</span>
      </div>

      <div class="row3">
        <div>
          <label>Date</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>Amount (use negative for expense)</label>
          <input id="amount" type="number" step="0.01" placeholder="e.g. 1500 or -250.75" />
        </div>
        <div>
          <label>Bank Account (last 4 digits)</label>
          <select id="account">
            <option value="8930">8930</option>
            <option value="9081">9081</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Vendor (AP)</label>
          <input id="vendor" list="vendorList" placeholder="e.g. WENTWORTH TIRE SERVICES" />
          <datalist id="vendorList"></datalist>
          <div class="small">Optional for P&L only entries. Required for Vendor/AP tracking.</div>
        </div>
        <div>
          <label>Vendor Txn Type (AP)</label>
          <select id="txnType">
            <option value="">(none)</option>
            <option value="BILL">BILL (increases payable)</option>
            <option value="PAYMENT">PAYMENT (decreases payable)</option>
            <option value="CREDIT">CREDIT (decreases payable)</option>
          </select>
        </div>
        <div>
          <label>Reference # (invoice/check/bank ref)</label>
          <input id="refNo" placeholder="e.g. INV12345 / CHECK 2555 / 90035199" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Category (P&L)</label>
          <select id="category">
            <option value="Sales">Sales</option>
            <option value="Sales Reimbursement">Sales Reimbursement</option>
            <option value="COGS">COGS</option>
            <option value="Repairs & Maintenance">Repairs & Maintenance</option>
            <option value="Fuel">Fuel</option>
            <option value="Payroll">Payroll</option>
            <option value="Contract Labor">Contract Labor</option>
            <option value="Loan from Others">Loan from Others</option>
            <option value="Internal Transfer">Internal Transfer</option>
            <option value="Other Expense">Other Expense</option>
            <option value="Other Income">Other Income</option>
          </select>
        </div>
        <div>
          <label>Vendor Group</label>
          <select id="vendorGroup">
            <option value="General">General</option>
            <option value="China Parts">China Parts</option>
            <option value="Paccar">Paccar</option>
          </select>
          <div class="small">This powers your “China Parts section” and “Paccar section”.</div>
        </div>
      </div>

      <label>Description / Memo</label>
      <textarea id="description" placeholder="e.g. Wentworth invoice / Zelle deposit / Transfer from CHK ..."></textarea>

      <div class="actions">
        <button id="saveBtn">Save</button>
        <button id="clearBtn" type="button">Clear</button>
        <span id="status"></span>
        <span class="pill" id="lockBadge" title="If a month is locked, you cannot save transactions inside that month.">Lock: checking…</span>
      </div>
      <div class="hint">Tip: Use “Audit Monthly → Editing Safety” to turn editing ON only when you are ready.</div>
    </div>

    <!-- MONTHLY SUMMARY -->
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Monthly P&L Summary (Category Logic)</h3>

        <div style="min-width:220px;">
          <label style="margin:0 0 6px;">Month</label>
          <input id="monthPick" type="month" />
        </div>

        <div style="min-width:220px;">
          <label style="margin:0 0 6px;">Account filter</label>
          <select id="filterAccount">
            <option value="ALL">All</option>
            <option value="8930">8930</option>
            <option value="9081">9081</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
      </div>

      <div class="summaryGrid">
        <div class="summaryBox">
          <div class="label">Income (Sales/Other Income/Reimb.)</div>
          <div class="value" id="sumIncome">$0.00</div>
        </div>
        <div class="summaryBox">
          <div class="label">Expenses (COGS/Payroll/etc.)</div>
          <div class="value" id="sumExpense">$0.00</div>
        </div>
        <div class="summaryBox">
          <div class="label">Net (Income − Expenses)</div>
          <div class="value" id="sumNet">$0.00</div>
        </div>
      </div>

      <div class="small" style="margin-top:8px;">
        Loans and Internal Transfers are excluded from P&L totals ✅
      </div>
    </div>

    <!-- RECENT TRANSACTIONS -->
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Recent Transactions (last 10)</h3>
        <div class="small">Uses the same account filter above</div>
      </div>
      <div id="list" class="list"></div>
      <div class="small muted">Full list is in the Transactions tab.</div>
    </div>
  </div>

  <!-- TRANSACTIONS -->
  <div class="tabPanel" id="tab-transactions">
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Transactions</h3>
        <button id="txRefreshBtn" type="button">Refresh</button>
        <button id="txExportXlsxBtn" type="button">Export View (Excel)</button>
        <button id="txExportCsvBtn" type="button">Export View (CSV)</button>
        <span id="txStatus" class="small muted"></span>
      </div>

      <div class="row4">
        <div>
          <label>Month (optional)</label>
          <input id="txMonth" type="month" />
        </div>
        <div>
          <label>Account</label>
          <select id="txAccount">
            <option value="ALL">All</option>
            <option value="8930">8930</option>
            <option value="9081">9081</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
        <div>
          <label>Vendor Group</label>
          <select id="txGroup">
            <option value="ALL">All</option>
            <option value="General">General</option>
            <option value="China Parts">China Parts</option>
            <option value="Paccar">Paccar</option>
          </select>
        </div>
        <div>
          <label>Txn Type</label>
          <select id="txTxnType">
            <option value="ALL">All</option>
            <option value="BILL">BILL</option>
            <option value="PAYMENT">PAYMENT</option>
            <option value="CREDIT">CREDIT</option>
            <option value="NONE">(none)</option>
          </select>
        </div>
      </div>

      <div class="row4">
        <div>
          <label>Search (vendor / memo / ref)</label>
          <input id="txSearch" placeholder="type to search…" />
        </div>
        <div>
          <label>Category</label>
          <select id="txCategory">
            <option value="ALL">All</option>
            <option value="Sales">Sales</option>
            <option value="Sales Reimbursement">Sales Reimbursement</option>
            <option value="COGS">COGS</option>
            <option value="Repairs & Maintenance">Repairs & Maintenance</option>
            <option value="Fuel">Fuel</option>
            <option value="Payroll">Payroll</option>
            <option value="Contract Labor">Contract Labor</option>
            <option value="Loan from Others">Loan from Others</option>
            <option value="Internal Transfer">Internal Transfer</option>
            <option value="Other Expense">Other Expense</option>
            <option value="Other Income">Other Income</option>
          </select>
        </div>
        <div>
          <label>Sort</label>
          <select id="txSort">
            <option value="date_desc">Date ↓</option>
            <option value="date_asc">Date ↑</option>
            <option value="amount_desc">Amount ↓</option>
            <option value="amount_asc">Amount ↑</option>
          </select>
        </div>
        <div>
          <label>Page size</label>
          <select id="txPageSize">
            <option value="25">25</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="txPrevBtn" type="button">◀ Prev</button>
        <span class="pill" id="txPagePill">Page 1</span>
        <button id="txNextBtn" type="button">Next ▶</button>
        <span class="small muted" id="txCount"></span>
      </div>

      <table>
        <thead>
          <tr>
            <th class="nowrap">Date</th>
            <th class="right nowrap">Amount</th>
            <th class="nowrap">Acct</th>
            <th class="nowrap">Category</th>
            <th class="nowrap">Vendor</th>
            <th class="nowrap">Type</th>
            <th class="nowrap">Ref</th>
            <th>Memo</th>
          </tr>
        </thead>
        <tbody id="txBody"></tbody>
      </table>
      <div class="small muted">Note: Editing is intentionally NOT available here to prevent accidental changes.</div>
    </div>
  </div>

  <!-- VENDORS -->
  <div class="tabPanel" id="tab-vendors">
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Vendors</h3>
        <div style="min-width:260px;">
          <label style="margin:0 0 6px;">Search vendor</label>
          <input id="vendorSearch" placeholder="type vendor name…" />
        </div>
        <div style="min-width:220px;">
          <label style="margin:0 0 6px;">Group filter</label>
          <select id="vendorGroupFilter">
            <option value="ALL">All</option>
            <option value="General">General</option>
            <option value="China Parts">China Parts</option>
            <option value="Paccar">Paccar</option>
          </select>
        </div>
      </div>

      <div class="small">Click a vendor row to view ledger.</div>
      <table>
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Group</th>
            <th class="right">Balance Due</th>
            <th class="right">Bills</th>
            <th class="right">Payments</th>
            <th class="right">Credits</th>
          </tr>
        </thead>
        <tbody id="vendorTableBody"></tbody>
      </table>
    </div>

    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Vendor Ledger</h3>
        <div class="pill" id="selectedVendorPill">No vendor selected</div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th class="right">Amount</th>
            <th>Ref</th>
            <th>Account</th>
            <th>Category</th>
            <th>Memo</th>
          </tr>
        </thead>
        <tbody id="vendorLedgerBody"></tbody>
      </table>
      <div class="small muted">Ledger shows only transactions with Vendor + Txn Type (BILL/PAYMENT/CREDIT).</div>
    </div>
  </div>

  <!-- AP SUMMARY -->
  <div class="tabPanel" id="tab-ap">
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">AP Summary (Vendor → Balance Due)</h3>
        <button id="refreshAPBtn" type="button">Refresh</button>
        <button id="exportAPBtn" type="button">Export AP to Excel</button>
        <button id="exportAPCsvBtn" type="button">Export AP to CSV</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Vendor</th>
            <th>Group</th>
            <th class="right">Balance (Payment Due)</th>
          </tr>
        </thead>
        <tbody id="apBody"></tbody>
      </table>
      <div class="small muted">Balance = Bills − Payments − Credits. Negative means vendor owes you (credit).</div>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="tabPanel" id="tab-audit">
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Audit Monthly (Lock / Unlock)</h3>
        <div style="min-width:220px;">
          <label style="margin:0 0 6px;">Month</label>
          <input id="auditMonth" type="month" />
        </div>
        <button id="lockMonthBtn" type="button">Lock Month</button>
        <button id="unlockMonthBtn" type="button">Unlock Month</button>
        <span id="auditStatus" class="small"></span>
      </div>

      <div class="small">
        When month is locked: you cannot save/import transactions with a date inside that month.
        Use “Archive” tab to export a month snapshot.
      </div>

      <div class="card" style="border-style:dashed;">
        <h4 style="margin:0 0 8px;">Locked Months</h4>
        <div id="lockedMonthsList" class="small muted">Loading…</div>
      </div>
    </div>

    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Editing Safety (Prevents Accidental Changes)</h3>
      </div>
      <div class="toggleRow">
        <input id="editModeToggle" type="checkbox" />
        <div>
          <div><b>Enable Editing</b> (Save + Import)</div>
          <div class="hint">OFF = safest. Turn ON only when you want to add/import data.</div>
        </div>
      </div>
      <div class="small muted">This is separate from “Monthly Lock”. Monthly Lock still blocks locked months even when editing is ON.</div>
    </div>
  </div>

  <!-- IMPORT / EXPORT -->
  <div class="tabPanel" id="tab-importexport">
    <div class="card">
      <h3 style="margin:0 0 10px;">Import Transactions (Excel/CSV)</h3>
      <div class="small">
        Best practice: import a clean table with these columns:
        <span class="mono">date, amount, account, category, description, vendor, txnType, refNo, vendorGroup</span>
      </div>

      <div class="actions">
        <input id="importFile" type="file" accept=".xlsx,.xls,.csv" />
        <button id="importBtn" type="button">Import Now</button>
        <span id="importStatus" class="small"></span>
      </div>

      <div class="card" style="border-style:dashed;">
        <h4 style="margin:0 0 8px;">Download Import Template</h4>
        <div class="actions">
          <button id="downloadTemplateXlsx" type="button">Template (Excel)</button>
          <button id="downloadTemplateCsv" type="button">Template (CSV)</button>
        </div>
        <div class="small muted">Use this template to avoid broken imports.</div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px;">Export Transactions (Excel/CSV)</h3>
      <div class="row">
        <div>
          <label>Month (optional)</label>
          <input id="exportMonth" type="month" />
          <div class="small muted">Leave empty to export all.</div>
        </div>
        <div>
          <label>Account filter</label>
          <select id="exportAccount">
            <option value="ALL">All</option>
            <option value="8930">8930</option>
            <option value="9081">9081</option>
            <option value="OTHER">OTHER</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="exportXlsx" type="button">Export Excel</button>
        <button id="exportCsv" type="button">Export CSV</button>
        <span id="exportStatus" class="small"></span>
      </div>
    </div>
  </div>

  <!-- ARCHIVE -->
  <div class="tabPanel" id="tab-archive">
    <div class="card">
      <div class="actions" style="margin-top:0;">
        <h3 style="margin:0; flex:1;">Archive (Monthly Snapshot Export)</h3>
        <div style="min-width:220px;">
          <label style="margin:0 0 6px;">Month</label>
          <input id="archiveMonth" type="month" />
        </div>
        <button id="archiveXlsxBtn" type="button">Export Month Archive (Excel)</button>
        <button id="archiveCsvBtn" type="button">Export Month Archive (CSV)</button>
        <span id="archiveStatus" class="small"></span>
      </div>
      <div class="small muted">
        This creates a “frozen snapshot file” you can store as backup. Locking is controlled in Audit Monthly tab.
      </div>
    </div>
  </div>

  <!-- SheetJS for Excel import/export (LOCAL) -->
  <script src="./libs/xlsx.full.min.js"></script>

  <script type="module" src="./js/main.js"></script>
</body>
</html>
